# Production docker-compose for EC2 deployment
# Uses IAM Role for AWS credentials (no need to mount ~/.aws)

services:
  # Flyway migration container - runs once before app starts
  # Requires DB_HOST (e.g., inboop-db.xxx.rds.amazonaws.com) and DB_NAME (e.g., postgres)
  flyway:
    image: flyway/flyway:10-alpine
    container_name: inboop-flyway
    command: >
      -url=jdbc:postgresql://${DB_HOST}:5432/${DB_NAME:-postgres}
      -user=${DB_USER}
      -password=${DB_PASSWORD}
      -baselineOnMigrate=true
      -baselineVersion=0
      -connectRetries=10
      migrate
    volumes:
      - ./src/main/resources/db/migration:/flyway/sql:ro

  app:
    image: ${ECR_IMAGE:-058264276362.dkr.ecr.us-east-2.amazonaws.com/inboop-backend:latest}
    container_name: inboop-backend
    depends_on:
      flyway:
        condition: service_completed_successfully
    ports:
      - "8080:8080"
    environment:
      # Spring Profile
      SPRING_PROFILES_ACTIVE: aws

      # AWS Configuration (for Secrets Manager)
      AWS_REGION: ${AWS_REGION:-us-east-2}
      AWS_SECRET_NAME: ${AWS_SECRET_NAME}

      # Database Configuration
      DB_URL: ${DB_URL}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DRIVER: org.postgresql.Driver
      DB_PLATFORM: org.hibernate.dialect.PostgreSQLDialect
      DDL_AUTO: ${DDL_AUTO:-update}

      # JWT
      JWT_SECRET: ${JWT_SECRET}

      # OAuth (set in .env)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      BACKEND_URL: ${BACKEND_URL:-https://api.inboop.com}

      # CORS
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-https://inboop.com,https://app.inboop.com}

      # Instagram
      INSTAGRAM_WEBHOOK_VERIFY_TOKEN: ${INSTAGRAM_WEBHOOK_VERIFY_TOKEN:-inboop_verify_token}

      # Facebook/Instagram OAuth
      FACEBOOK_APP_ID: ${FACEBOOK_APP_ID:-}
      FACEBOOK_APP_SECRET: ${FACEBOOK_APP_SECRET:-}

      # Meta App Secret (for data deletion callbacks)
      META_APP_SECRET: ${META_APP_SECRET:-}

      # Disable H2 console in production
      H2_CONSOLE_ENABLED: "false"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
