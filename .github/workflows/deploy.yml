name: CI/CD

on:
  push:
    branches: ['**']

env:
  AWS_REGION: us-east-2
  ECR_REPOSITORY: inboop-backend

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build and run tests
        run: ./mvnw clean verify -B

  deploy:
    name: Deploy to EC2
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build JAR
        run: ./mvnw clean package -DskipTests -B

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Deploy to EC2 with rollback support
        uses: appleboy/ssh-action@v1.0.3
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: ECR_REGISTRY,IMAGE_TAG,ECR_REPOSITORY
          script: |
            set -e
            cd /opt/inboop

            echo "=== Starting deployment ==="
            echo "Image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

            # Pull latest deployment files from git
            echo "=== Pulling latest deployment files ==="
            git fetch origin master
            git checkout origin/master -- docker-compose.prod.yml src/main/resources/db/migration/

            # Login to ECR
            aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin $ECR_REGISTRY

            # Save current image tag for rollback
            CURRENT_IMAGE=$(docker inspect --format='{{.Config.Image}}' inboop-backend 2>/dev/null || echo "none")
            echo "Current image: $CURRENT_IMAGE"
            echo "$CURRENT_IMAGE" > /opt/inboop/.previous_image

            # Pull new image
            echo "=== Pulling new image ==="
            docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
            docker pull $ECR_REGISTRY/$ECR_REPOSITORY:latest

            # Stop existing container gracefully
            echo "=== Stopping current container ==="
            docker-compose -f docker-compose.prod.yml down --timeout 30 || true

            # Run Flyway migrations first
            echo "=== Running database migrations ==="
            docker-compose -f docker-compose.prod.yml up flyway

            # Check if migrations succeeded
            if [ $? -ne 0 ]; then
              echo "=== MIGRATION FAILED ==="
              docker logs inboop-flyway --tail 50
              exit 1
            fi

            # Start app container (flyway already completed)
            echo "=== Starting app container ==="
            docker-compose -f docker-compose.prod.yml up -d app

            # Wait for container to be healthy
            echo "=== Waiting for health check ==="
            HEALTH_CHECK_RETRIES=12
            HEALTH_CHECK_INTERVAL=10

            for i in $(seq 1 $HEALTH_CHECK_RETRIES); do
              echo "Health check attempt $i/$HEALTH_CHECK_RETRIES..."
              sleep $HEALTH_CHECK_INTERVAL

              # Check if container is running
              if ! docker ps | grep -q inboop-backend; then
                echo "Container not running, checking logs..."
                docker logs inboop-backend --tail 50

                # Rollback
                echo "=== ROLLBACK: Container failed to start ==="
                if [ -f /opt/inboop/.previous_image ] && [ "$CURRENT_IMAGE" != "none" ]; then
                  docker pull $CURRENT_IMAGE || true
                  docker-compose -f docker-compose.prod.yml down || true
                  docker tag $CURRENT_IMAGE $ECR_REGISTRY/$ECR_REPOSITORY:latest || true
                  docker-compose -f docker-compose.prod.yml up -d || true
                fi
                exit 1
              fi

              # Check health endpoint
              if curl -sf http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "=== Health check passed! ==="
                break
              fi

              if [ $i -eq $HEALTH_CHECK_RETRIES ]; then
                echo "=== Health check failed after $HEALTH_CHECK_RETRIES attempts ==="
                docker logs inboop-backend --tail 100

                # Rollback
                echo "=== ROLLBACK: Health check failed ==="
                if [ -f /opt/inboop/.previous_image ] && [ "$CURRENT_IMAGE" != "none" ]; then
                  docker-compose -f docker-compose.prod.yml down || true
                  docker tag $CURRENT_IMAGE $ECR_REGISTRY/$ECR_REPOSITORY:latest || true
                  docker-compose -f docker-compose.prod.yml up -d || true
                fi
                exit 1
              fi
            done

            # Cleanup old images (keep last 3)
            echo "=== Cleaning up old images ==="
            docker image prune -f || true

            echo "=== Deployment successful! ==="
            docker ps
